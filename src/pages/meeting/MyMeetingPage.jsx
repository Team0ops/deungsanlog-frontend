import { useState, useEffect } from "react";
import { useMediaQuery } from "@mui/material";
import {
  Box,
  Typography,
  CircularProgress,
  useTheme,
  Pagination,
  Tabs,
  Tab,
  Select,
  MenuItem,
  FormControl,
  InputLabel,
  TextField,
  Grid,
  Button,
} from "@mui/material";
import axiosInstance from "shared/lib/axiosInstance";
import { getUserInfo } from "shared/lib/auth";
import MeetingCard from "widgets/meeting/MeetingCard";
import MyMeetingHeader from "widgets/meeting/MyMeetingHeader";
import LoginRequiredModal from "shared/components/LoginRequiredModal";
import { useNavigate } from "react-router-dom";

const MyMeetingPage = () => {
  const [meetings, setMeetings] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [page, setPage] = useState(0);
  const [totalPages, setTotalPages] = useState(1);
  const [activeTab, setActiveTab] = useState(0); // 0: Ï∞∏Ïó¨Ìïú Î™®ÏûÑ, 1: Í∞úÏÑ§Ìïú Î™®ÏûÑ

  // ÌïÑÌÑ∞ÎßÅ ÏÉÅÌÉú
  const [statusFilter, setStatusFilter] = useState("all");
  const [sortOption, setSortOption] = useState("latest");
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");

  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));
  const navigate = useNavigate();

  const userInfo = getUserInfo();
  const isLoggedIn = !!userInfo?.userId;
  const MEETINGS_PER_PAGE = 4;

  // ÏÉÅÌÉú ÏòµÏÖò
  const statusOptions = [
    { value: "all", label: "Ï†ÑÏ≤¥" },
    { value: "OPEN", label: "Î™®ÏßëÏ§ë" },
    { value: "CANCELLED", label: "Ï∑®ÏÜå" },
    { value: "CLOSED", label: "ÎßàÍ∞ê" },
  ];

  // Ï†ïÎ†¨ ÏòµÏÖò
  const sortOptions = [
    { value: "latest", label: "ÏµúÏã†Ïàú" },
    { value: "oldest", label: "Ïò§ÎûòÎêúÏàú" },
    { value: "deadline", label: "ÎßàÍ∞êÏùºÏàú" },
  ];

  useEffect(() => {
    console.log("MyMeetingPage Î°úÎìúÎê®");
    console.log("Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú:", isLoggedIn);
    console.log("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥:", userInfo);

    if (!isLoggedIn) {
      setShowLoginModal(true);
      setLoading(false);
      return;
    }

    const fetchMyMeetings = async () => {
      try {
        console.log("ÎÇ¥ Î™®ÏûÑ Ï°∞Ìöå ÏãúÏûë");
        console.log(
          "ÌòÑÏû¨ ÌÉ≠:",
          activeTab === 0 ? "Ï∞∏Ïó¨Ìïú Î™®ÏûÑ" : "Í∞úÏÑ§Ìïú Î™®ÏûÑ"
        );

        let meetingIds = [];

        if (activeTab === 0) {
          // Ï∞∏Ïó¨Ìïú Î™®ÏûÑ Ï°∞Ìöå
          const idsResponse = await axiosInstance.get(
            `/meeting-service/my-meeting-ids?userId=${userInfo.userId}`
          );
          meetingIds = idsResponse.data;
          console.log("Ï∞∏Ïó¨Ìïú Î™®ÏûÑ IDÎì§:", meetingIds);
        } else {
          // Í∞úÏÑ§Ìïú Î™®ÏûÑ Ï°∞Ìöå
          const idsResponse = await axiosInstance.get(
            `/meeting-service/my-hosted-meeting-ids?userId=${userInfo.userId}`
          );
          meetingIds = idsResponse.data;
          console.log("Í∞úÏÑ§Ìïú Î™®ÏûÑ IDÎì§:", meetingIds);
        }

        if (meetingIds.length === 0) {
          setMeetings([]);
          setTotalPages(1);
          setLoading(false);
          return;
        }

        // 2. Í∞Å Î™®ÏûÑÏùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        const meetingPromises = meetingIds.map((meetingId) =>
          axiosInstance.get(`/meeting-service/${meetingId}`)
        );

        const meetingResponses = await Promise.all(meetingPromises);
        const meetingData = meetingResponses.map((response) => response.data);

        // 3. ÏÉÅÌÉú ÌïÑÌÑ∞ÎßÅ
        let filteredMeetings = meetingData;
        if (statusFilter !== "all") {
          filteredMeetings = meetingData.filter(
            (meeting) => meeting.status === statusFilter
          );
        }

        // 4. ÎÇ†Ïßú ÌïÑÌÑ∞ÎßÅ
        if (startDate) {
          filteredMeetings = filteredMeetings.filter(
            (meeting) => meeting.scheduledDate >= startDate
          );
        }
        if (endDate) {
          filteredMeetings = filteredMeetings.filter(
            (meeting) => meeting.scheduledDate <= endDate
          );
        }

        // 5. Ï†ïÎ†¨
        switch (sortOption) {
          case "oldest":
            filteredMeetings.sort((a, b) => {
              const dateA = new Date(`${a.scheduledDate}T${a.scheduledTime}`);
              const dateB = new Date(`${b.scheduledDate}T${b.scheduledTime}`);
              return dateA - dateB;
            });
            break;
          case "deadline":
            filteredMeetings.sort((a, b) => {
              const dateA = new Date(a.deadlineDate);
              const dateB = new Date(b.deadlineDate);
              return dateA - dateB;
            });
            break;
          case "latest":
          default:
            filteredMeetings.sort((a, b) => {
              const dateA = new Date(`${a.scheduledDate}T${a.scheduledTime}`);
              const dateB = new Date(`${b.scheduledDate}T${b.scheduledTime}`);
              return dateB - dateA;
            });
            break;
        }

        // 6. ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Í≥ÑÏÇ∞
        const totalPagesCount = Math.ceil(
          filteredMeetings.length / MEETINGS_PER_PAGE
        );
        setTotalPages(totalPagesCount);

        // 7. ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏùò Î™®ÏûÑÎì§Îßå ÏÑ§Ï†ï
        const startIndex = page * MEETINGS_PER_PAGE;
        const endIndex = startIndex + MEETINGS_PER_PAGE;
        const currentPageMeetings = filteredMeetings.slice(
          startIndex,
          endIndex
        );

        setMeetings(currentPageMeetings);
        console.log("ÌïÑÌÑ∞ÎßÅÎêú Î™®ÏûÑ Í≤∞Í≥º:", currentPageMeetings);
      } catch (error) {
        console.error("‚ùå ÎÇ¥ Î™®ÏûÑ Ï°∞Ìöå Ïã§Ìå®:", error);
        setMeetings([]);
        setTotalPages(1);
      } finally {
        setLoading(false);
      }
    };

    fetchMyMeetings();
  }, [
    isLoggedIn,
    userInfo?.userId,
    page,
    activeTab,
    statusFilter,
    sortOption,
    startDate,
    endDate,
  ]);

  const handlePageChange = (event, newPage) => {
    console.log("üìÑ ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω:", newPage);
    setPage(newPage - 1); // MUI PaginationÏùÄ 1Î∂ÄÌÑ∞ ÏãúÏûëÌïòÎØÄÎ°ú -1
  };

  const handleTabChange = (event, newValue) => {
    console.log("üìë ÌÉ≠ Î≥ÄÍ≤Ω:", newValue);
    setActiveTab(newValue);
    setPage(0); // ÌÉ≠ Î≥ÄÍ≤Ω Ïãú Ï≤´ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
  };

  const handleStatusFilterChange = (event) => {
    setStatusFilter(event.target.value);
    setPage(0);
  };

  const handleSortOptionChange = (event) => {
    setSortOption(event.target.value);
    setPage(0);
  };

  const handleDateChange = (type, value) => {
    if (type === "start") {
      setStartDate(value);
    } else {
      setEndDate(value);
    }
    setPage(0);
  };

  const handleClearFilters = () => {
    setStatusFilter("all");
    setSortOption("latest");
    setStartDate("");
    setEndDate("");
    setPage(0);
  };

  const handleLogin = () => {
    setShowLoginModal(false);
    navigate("/login");
  };

  const handleCloseModal = () => {
    setShowLoginModal(false);
  };

  if (loading) {
    return (
      <Box
        sx={{
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          minHeight: "60vh",
        }}
      >
        <CircularProgress />
      </Box>
    );
  }

  return (
    <>
      <div
        style={{
          minWidth: "90%",
          maxWidth: "100%",
          minHeight: "40vh",
          display: "flex",
          flexDirection: "column",
          backgroundColor: "transparent",
          borderRadius: "20px",
          padding: isMobile
            ? "clamp(0.8rem, 3vw, 1rem)"
            : "clamp(1rem, 4vw, 1.5rem)",
          position: "relative",
          height: "calc(100vh - 40px)",
        }}
      >
        <div
          style={{
            width: "100%",
            maxWidth: "1000px",
            margin: "0 auto",
            display: "flex",
            flexDirection: "column",
            gap: isMobile ? "1rem" : "1.2rem",
            height: "100%",
          }}
        >
          {/* Ìó§Îçî */}
          <MyMeetingHeader />

          {/* ÌÉ≠ */}
          <Box
            sx={{
              borderBottom: 1,
              borderColor: "#e0e0e0",
              backgroundColor: "transparent",
              borderRadius: "12px 12px 0 0",
              px: 2,
            }}
          >
            <Tabs
              value={activeTab}
              onChange={handleTabChange}
              sx={{
                "& .MuiTab-root": {
                  color: "#666",
                  fontWeight: 600,
                  fontSize: isMobile ? "0.95rem" : "1.05rem",
                  textTransform: "none",
                  minWidth: "auto",
                  padding: isMobile ? "1rem 1.2rem" : "1.2rem 1.8rem",
                  borderRadius: "8px 8px 0 0",
                  marginRight: "4px",
                  transition: "all 0.2s ease-in-out",
                  cursor: "pointer",
                  outline: "none",
                  "&:hover": {
                    backgroundColor: "#f0f0f0",
                    color: "#4c7559",
                    outline: "none",
                  },
                  "&:focus": {
                    outline: "none",
                  },
                  "&:focus-visible": {
                    outline: "none",
                  },
                },
                "& .Mui-selected": {
                  color: "#4c7559",
                  fontWeight: 700,
                  backgroundColor: "transparent",
                  border: "1px solid #e0e0e0",
                  borderBottom: "none",
                  boxShadow: "none",
                },
                "& .MuiTabs-indicator": {
                  backgroundColor: "#4c7559",
                  height: 4,
                  borderRadius: "2px 2px 0 0",
                },
              }}
            >
              <Tab label="Ï∞∏Ïó¨Ìïú Î™®ÏûÑ" />
              <Tab label="Í∞úÏÑ§Ìïú Î™®ÏûÑ" />
            </Tabs>
          </Box>

          {/* ÌïÑÌÑ∞ÎßÅ UI */}
          <Box
            sx={{
              backgroundColor: "white",
              borderRadius: "0 0 12px 12px",
              p: 3,
              mb: 3,
              border: "1px solid #e0e0e0",
              borderTop: "none",
              boxShadow: "0 2px 8px rgba(0,0,0,0.08)",
            }}
          >
            <Grid container spacing={2} alignItems="center">
              {/* ÏÉÅÌÉú ÌïÑÌÑ∞ */}
              <Grid item xs={12} sm={6} md={3}>
                <FormControl fullWidth size="medium">
                  <InputLabel sx={{ color: "#2d5a3d", fontWeight: 600 }}>
                    ÏÉÅÌÉú
                  </InputLabel>
                  <Select
                    value={statusFilter}
                    onChange={handleStatusFilterChange}
                    label="ÏÉÅÌÉú"
                    sx={{
                      backgroundColor: "#f8f9fa",
                      borderRadius: "8px",
                      py: 0.5,
                      "& .MuiOutlinedInput-notchedOutline": {
                        borderColor: "#e0e0e0",
                      },
                      "&:hover .MuiOutlinedInput-notchedOutline": {
                        borderColor: "#4c7559",
                      },
                      "&.Mui-focused .MuiOutlinedInput-notchedOutline": {
                        borderColor: "#4c7559",
                      },
                      "& .MuiInputLabel-root": {
                        color: "#2d5a3d",
                        "&.Mui-focused": {
                          color: "#4c7559",
                        },
                      },
                    }}
                  >
                    {statusOptions.map((option) => (
                      <MenuItem key={option.value} value={option.value}>
                        {option.label}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>

              {/* Ï†ïÎ†¨ ÏòµÏÖò */}
              <Grid item xs={12} sm={6} md={3}>
                <FormControl fullWidth size="medium">
                  <InputLabel sx={{ color: "#2d5a3d", fontWeight: 600 }}>
                    Ï†ïÎ†¨
                  </InputLabel>
                  <Select
                    value={sortOption}
                    onChange={handleSortOptionChange}
                    label="Ï†ïÎ†¨"
                    sx={{
                      backgroundColor: "#f8f9fa",
                      borderRadius: "8px",
                      py: 0.5,
                      "& .MuiOutlinedInput-notchedOutline": {
                        borderColor: "#e0e0e0",
                      },
                      "&:hover .MuiOutlinedInput-notchedOutline": {
                        borderColor: "#4c7559",
                      },
                      "&.Mui-focused .MuiOutlinedInput-notchedOutline": {
                        borderColor: "#4c7559",
                      },
                      "& .MuiInputLabel-root": {
                        color: "#2d5a3d",
                        "&.Mui-focused": {
                          color: "#4c7559",
                        },
                      },
                    }}
                  >
                    {sortOptions.map((option) => (
                      <MenuItem key={option.value} value={option.value}>
                        {option.label}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>

              {/* ÏãúÏûë ÎÇ†Ïßú */}
              <Grid item xs={12} sm={6} md={2}>
                <TextField
                  type="date"
                  label="ÏãúÏûëÏùº"
                  value={startDate}
                  onChange={(e) => handleDateChange("start", e.target.value)}
                  size="medium"
                  fullWidth
                  InputLabelProps={{
                    shrink: true,
                    sx: { color: "#2d5a3d", fontWeight: 600 },
                  }}
                  sx={{
                    backgroundColor: "#f8f9fa",
                    borderRadius: "8px",
                    py: 0.5,
                    "& .MuiOutlinedInput-notchedOutline": {
                      borderColor: "#e0e0e0",
                    },
                    "&:hover .MuiOutlinedInput-notchedOutline": {
                      borderColor: "#4c7559",
                    },
                    "&.Mui-focused .MuiOutlinedInput-notchedOutline": {
                      borderColor: "#4c7559",
                    },
                  }}
                />
              </Grid>

              {/* Ï¢ÖÎ£å ÎÇ†Ïßú */}
              <Grid item xs={12} sm={6} md={2}>
                <TextField
                  type="date"
                  label="Ï¢ÖÎ£åÏùº"
                  value={endDate}
                  onChange={(e) => handleDateChange("end", e.target.value)}
                  size="medium"
                  fullWidth
                  InputLabelProps={{
                    shrink: true,
                    sx: { color: "#2d5a3d", fontWeight: 600 },
                  }}
                  sx={{
                    backgroundColor: "#f8f9fa",
                    borderRadius: "8px",
                    py: 0.5,
                    "& .MuiOutlinedInput-notchedOutline": {
                      borderColor: "#e0e0e0",
                    },
                    "&:hover .MuiOutlinedInput-notchedOutline": {
                      borderColor: "#4c7559",
                    },
                    "&.Mui-focused .MuiOutlinedInput-notchedOutline": {
                      borderColor: "#4c7559",
                    },
                  }}
                />
              </Grid>

              {/* ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî Î≤ÑÌäº */}
              <Grid item xs={12} sm={12} md={2}>
                <Button
                  variant="outlined"
                  onClick={handleClearFilters}
                  size="medium"
                  fullWidth
                  sx={{
                    color: "#2d5a3d",
                    borderColor: "transparent",
                    borderWidth: "0px",
                    backgroundColor: "white",
                    borderRadius: "8px",
                    fontWeight: 600,
                    textTransform: "none",
                    py: 1.2,
                    outline: "none",
                    "&:hover": {
                      borderColor: "transparent",
                      backgroundColor: "#f0f8f0",
                      color: "#1a3d2a",
                    },
                    "&:focus": {
                      outline: "none",
                    },
                    "&:focus-visible": {
                      outline: "none",
                    },
                  }}
                >
                  ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
                </Button>
              </Grid>
            </Grid>
          </Box>

          {/* Î™®ÏûÑ Î¶¨Ïä§Ìä∏ */}
          <Box
            sx={{
              flex: 1,
              overflowY: "auto",
              overflowX: "hidden",
              minHeight: 0,
              paddingRight: "2px",
              position: "relative",
            }}
          >
            {/* ÏïÑÎûòÏ™Ω Î∏îÎü¨ */}
            <div
              style={{
                position: "sticky",
                bottom: 0,
                left: 0,
                width: "100%",
                height: "32px",
                zIndex: 20,
                pointerEvents: "none",
                backdropFilter: "blur(6px)",
              }}
            />

            {/* Î™®ÏûÑ Ïπ¥Îìú Î¶¨Ïä§Ìä∏ */}
            <Box
              display="flex"
              flexDirection="column"
              gap={isMobile ? 1.5 : 2}
              mb={isMobile ? 2 : 3}
            >
              {meetings && meetings.length > 0 ? (
                meetings.map((meeting) => (
                  <MeetingCard key={meeting.id} meeting={meeting} />
                ))
              ) : (
                <Box
                  width="100%"
                  textAlign="center"
                  color="#888"
                  py={isMobile ? 4 : 6}
                  sx={{
                    fontSize: isMobile ? "clamp(0.9rem, 3vw, 1rem)" : "inherit",
                    fontFamily: "'GmarketSansMedium', sans-serif",
                    lineHeight: 1.6,
                  }}
                >
                  {activeTab === 0 ? (
                    <>
                      ÏïÑÏßÅ Ï∞∏Ïó¨Ìïú Î™®ÏûÑÏù¥ ÏóÜÏñ¥Ïöî! üèûÔ∏è <br />
                      ÏÉàÎ°úÏö¥ Î™®ÏûÑÏóê Ï∞∏Í∞ÄÌï¥Î≥¥Îäî Í±¥ Ïñ¥ÎïåÏöî?
                    </>
                  ) : (
                    <>
                      ÏïÑÏßÅ Í∞úÏÑ§Ìïú Î™®ÏûÑÏù¥ ÏóÜÏñ¥Ïöî! üèîÔ∏è <br />
                      ÏÉàÎ°úÏö¥ Î™®ÏûÑÏùÑ ÎßåÎì§Ïñ¥Î≥¥Îäî Í±¥ Ïñ¥ÎïåÏöî?
                    </>
                  )}
                </Box>
              )}
            </Box>

            {/* ÌéòÏù¥Ïßï */}
            <Box
              display="flex"
              justifyContent="center"
              mt={isMobile ? 1.5 : 2}
              pb={isMobile ? 1 : 2}
            >
              <Pagination
                count={totalPages}
                page={page + 1}
                onChange={handlePageChange}
                color="primary"
                shape="rounded"
                size={isMobile ? "medium" : "large"}
                siblingCount={isMobile ? 0 : 1}
                boundaryCount={isMobile ? 1 : 1}
                showFirstButton={!isMobile}
                showLastButton={!isMobile}
                sx={{
                  "& .MuiPaginationItem-root": {
                    color: "#356849",
                    fontWeight: 600,
                    borderRadius: "24px !important",
                    outline: "none",
                    fontSize: isMobile ? "0.9rem" : "1rem",
                    minWidth: isMobile ? "32px" : "40px",
                    height: isMobile ? "32px" : "40px",
                  },
                  "& .Mui-selected": {
                    backgroundColor: "#bfccb185 !important",
                    color: "#143622 !important",
                    border: "none",
                    borderRadius: "24px !important",
                    outline: "none",
                  },
                  "& .MuiPaginationItem-root:hover": {
                    backgroundColor: "#b5b9ae1c",
                    borderRadius: "24px !important",
                    outline: "none",
                  },
                }}
              />
            </Box>
          </Box>
        </div>
      </div>

      {/* Î°úÍ∑∏Ïù∏ ÌïÑÏöî Î™®Îã¨ */}
      <LoginRequiredModal
        isOpen={showLoginModal}
        onClose={handleCloseModal}
        onLogin={handleLogin}
        title="Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§"
        message="ÎÇòÏùò Î™®ÏûÑ Ï∞∏Ïó¨ ÌòÑÌô©ÏùÑ Î≥¥Î†§Î©¥\nÎ°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï¥Ïöî!"
      />
    </>
  );
};

export default MyMeetingPage;
